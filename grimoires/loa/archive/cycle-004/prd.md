# PRD: Cycle 004 — Discovery & Browse

**Version**: 1.0.0
**Date**: 2026-02-15
**Cycle**: 004
**Status**: Draft

> Sources: `grimoires/loa/context/codex-improvement-research.md`, Cycle 001-003 learnings, `grimoires/loa/NOTES.md`

---

## 1. Problem Statement

Cycles 001–003 built the codex's structural foundation: 10,000 Mibera files have YAML frontmatter, data is normalized, schemas are defined, and semantic validation exists. But the data is still flat — you can browse by one dimension at a time (archetype, ancestor, drug, etc.) but you can't explore the **intersections** that make individual Miberas interesting. A Freetekno/Greek Mibera with an Earth element and MDMA is a specific kind of being — and nothing in the codex surfaces that.

Additionally, there's no aggregate view of the data (distributions, patterns, outliers), no graph representation of entity relationships, no formal data model beyond individual schemas, and two known data issues remain from Cycle 002.

This cycle makes the codex **explorable** — cross-dimensional browse pages, computed statistics, a relationship graph, and coherence scoring that reveals the hidden harmony (or tension) within each Mibera's identity.

---

## 2. Goals & Success Metrics

| Goal | Metric | Target |
|------|--------|--------|
| Cross-dimensional browse pages | Cluster MOC pages generated | ~150-200 |
| Aggregate statistics | Stats pages with distribution tables | All major dimensions |
| Relationship graph | `_data/graph.json` exists and is valid | All entity types |
| Formal data model | `_schema/ontology.yaml` exists | All relationships documented |
| Data issues resolved | Remaining blockers from NOTES.md | 0 |
| No regressions | `audit-structure.sh` 0 errors | Same as baseline |

---

## 3. Scope

### In Scope (5 features)

| ID | Research # | Feature | Output |
|----|-----------|---------|--------|
| F1 | #10 | Fix remaining data issues (bufotenin rename, hiberanation-eye-mask-2) | File fixes |
| F2 | #12 | Cluster MOCs — cross-dimensional browse pages | ~150-200 new `.md` files |
| F3 | #23 | Stats dashboard — aggregate statistics in Markdown | `_data/stats.md` |
| F4 | #2 | Graph export — entity relationship adjacency list | `_data/graph.json` |
| F5 | #4 | Ontology file — formal data model | `_schema/ontology.yaml` |

### Out of Scope

- Static site generation (Astro/Starlight) — future cycle
- D3.js visualization — future cycle (depends on graph.json from this cycle)
- MCP server — future cycle
- RAG corpus — future cycle
- Canon tiers / holder lore — future cycle
- Cosmological coherence scoring — rejected (externally imposed analytical lens, not native to Mibera's design)
- Status field on frontmatter — rejected (against spirit of the project)
- Slug-based foreign keys — deferred
- CI pipeline — deferred
- Tags system — deferred

---

## 4. Functional Requirements

### F1: Fix Remaining Data Issues (P0)

Resolve the two long-standing data blockers from NOTES.md.

**bufotenin rename**:
- Rename `drugs-detailed/bufotenine.md` → `drugs-detailed/bufotenin.md`
- Update all references across the codex (tarot card `the-tower.md`, backlinks, browse pages, etc.)
- Update frontmatter in any Mibera files that reference this drug
- Re-run semantic audit to confirm bidirectional reference check passes

**hiberanation-eye-mask-2**:
- Investigate what `hiberanation-eye-mask-2.md` should be (likely typo for `hibernation-eye-mask-2.md`)
- Either create the file or fix the reference in the masks index
- Verify with `audit-links.sh`

**Acceptance**:
- `audit-semantic.py`: 8/8 checks pass (bufotenin mismatch resolved)
- `audit-links.sh`: ≤8 broken links (improvement from current 10)
- No regressions in structure audit

### F2: Cluster MOCs — Cross-Dimensional Browse Pages (P0)

Create `_scripts/generate-clusters.py` that generates Markdown browse pages for high-value dimension pairs. Each page lists all Miberas matching that combination.

**Dimension pairs to generate**:

| Pair | Dimensions | Estimated Pages |
|------|-----------|-----------------|
| Archetype × Ancestor | 4 × 33 | Up to 132 |
| Archetype × Element | 4 × 4 | Up to 16 |
| Ancestor × Element | 33 × 4 | Up to 132 |

Only generate pages for combinations with ≥1 Mibera. Skip empty intersections.

**Page format**:
```markdown
# Freetekno × Greek

*Archetype: Freetekno | Ancestor: Greek*

**247 Miberas** in this cluster.

[#0001](../../miberas/0001.md) • [#0042](../../miberas/0042.md) • [#0103](../../miberas/0103.md) • ...

---

*Generated by `_scripts/generate-clusters.py`*
```

**Output directory**: `browse/clusters/`
**Filename convention**: `{dimension1-value}-{dimension2-value}.md` (slugified)
**Index page**: `browse/clusters/index.md` with table of all clusters sorted by Mibera count

**Rules**:
- Follow the same inline link format as existing browse pages (`[#NNNN](path) • ...`)
- Max 50 inline links with "... and N more" for clusters >50 Miberas
- Include total count prominently
- Script is idempotent (uses `<!-- @generated -->` markers or full file regeneration)
- Update `SUMMARY.md` with cluster section

**Acceptance**:
- Cluster pages exist in `browse/clusters/`
- `browse/clusters/index.md` exists with all clusters listed
- All links are valid (`audit-links.sh` no new broken links)
- Page count is in the 150-200 range
- Every Mibera appears in at least one cluster page per pair type

### F3: Stats Dashboard (P1)

Create `_scripts/generate-stats.py` that computes aggregate statistics and outputs Markdown tables.

**Statistics to compute**:

1. **Archetype distribution**: Count per archetype, percentage
2. **Ancestor distribution**: Count per ancestor, sorted by frequency
3. **Drug distribution**: Count per drug, sorted by frequency
4. **Element distribution**: Count per element
5. **Swag rank distribution**: Count per rank (Sss, Ss, S, A, B, C, D, F)
6. **Swag score histogram**: Distribution in buckets (0-10, 11-20, ..., 91-100)
7. **Time period distribution**: Ancient vs Modern count
8. **Sun sign distribution**: Count per zodiac sign
9. **Top trait combinations**: Most common archetype+ancestor+element combos (top 20)
10. **Drug-element cross-tab**: How drugs distribute across elements

**Output**: `_data/stats.md` — pure Markdown tables, renders on GitHub.

**Format example**:
```markdown
# Mibera Codex — Statistics

*Generated from 10,000 Mibera YAML frontmatter entries.*
*Last generated: 2026-02-15*

---

## Archetype Distribution

| Archetype | Count | Percentage |
|-----------|-------|------------|
| Freetekno | 2,501 | 25.01% |
| Milady | 2,499 | 24.99% |
| Chicago/Detroit | 2,500 | 25.00% |
| Acidhouse | 2,500 | 25.00% |
```

**Acceptance**:
- `_data/stats.md` exists with all 10 statistic groups
- All numbers sum correctly (archetypes sum to 10,000, elements sum to 10,000, etc.)
- Script is idempotent

### F4: Graph Export (P1)

Create `_scripts/generate-graph.py` that outputs `_data/graph.json` — an adjacency list capturing all entity relationships with typed edges.

**Node types**:
- `mibera` (10,000 nodes)
- `archetype` (4 nodes)
- `ancestor` (33 nodes)
- `drug` (78 nodes)
- `tarot_card` (78 nodes)
- `element` (4 nodes)
- `era` (2 nodes: Ancient, Modern)
- `zodiac` (12 nodes: sun signs)
- `swag_rank` (8 nodes)

**Edge types**:
- `has_archetype`: mibera → archetype
- `has_ancestor`: mibera → ancestor
- `has_drug`: mibera → drug
- `has_element`: mibera → element
- `born_in_era`: mibera → era
- `has_sun_sign`: mibera → zodiac
- `maps_to_tarot`: drug → tarot_card
- `has_suit_element`: tarot_card → element

**Format**:
```json
{
  "metadata": {
    "generated": "2026-02-15",
    "node_count": 10219,
    "edge_count": 60156
  },
  "nodes": [
    {"id": "mibera:1", "type": "mibera", "label": "Mibera #1"},
    {"id": "archetype:freetekno", "type": "archetype", "label": "Freetekno"}
  ],
  "edges": [
    {"source": "mibera:1", "target": "archetype:freetekno", "type": "has_archetype"}
  ]
}
```

**Acceptance**:
- `_data/graph.json` exists and is valid JSON
- All entity types represented as nodes
- All relationships represented as typed edges
- Self-validation: node count matches expectations, edge count matches expectations
- No orphan nodes (every node has at least one edge)

### F5: Ontology File (P2)

Create `_schema/ontology.yaml` that documents the complete data model — entity types, their relationships, and cardinality constraints. This sits above individual JSON schemas and captures the relational structure.

**Content**:
```yaml
entities:
  mibera:
    description: "A time-travelling Rebased Retard Bera"
    count: 10000
    relationships:
      - target: archetype
        type: has_archetype
        cardinality: many-to-one
      - target: ancestor
        type: has_ancestor
        cardinality: many-to-one
      # ...

  drug:
    description: "A molecule that shapes Mibera consciousness"
    count: 78
    relationships:
      - target: tarot_card
        type: maps_to_tarot
        cardinality: one-to-one
```

**Acceptance**:
- `_schema/ontology.yaml` exists and is valid YAML
- All 9+ entity types documented
- All relationship types documented with cardinality
- Consistent with actual data (counts match reality)

---

## 5. Technical Approach

- All scripts in `_scripts/` as standalone Python3 (consistent with Cycle 003 conventions)
- Scripts read YAML frontmatter using `yaml.safe_load` (proven pattern)
- Generated files use `<!-- @generated -->` markers or full file regeneration for idempotency
- Cluster MOCs follow existing browse page format (inline links, `•` separator)
- Stats dashboard is pure Markdown tables (no external dependencies)
- Graph export uses standard adjacency list format (compatible with D3.js, NetworkX, etc.)
- All outputs committed to repo (GitHub-native, Markdown-first)

---

## 6. Risks

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Cluster MOC count higher than expected | Low | Low | Filter: only generate for combos with ≥1 Mibera |
| graph.json too large for GitHub rendering | Medium | Low | JSON is data, not meant for browser viewing |
| Bufotenin rename breaks references | Low | High | Comprehensive search-and-replace + audit verification |
| Stats numbers reveal data quality issues | Medium | Low | Document as observations in NOTES.md |

---

## 7. Dependencies

- F1 (data fixes) should complete before F4 (graph) for clean data
- F2 (clusters) is independent — can run in parallel with anything
- F3 (stats) is independent
- F4 (graph) needs clean entity references (benefits from F1)
- F5 (ontology) is independent (documents existing structure)
